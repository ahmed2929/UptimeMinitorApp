<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>Controller/Users/general/index.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    <input type="text" id="nav-search" placeholder="Search" />
    
    
    <h2><a href="index.html">Home</a></h2><h2><a href="https://github.com/your-github-username/pet-adoption-center-sdk" target="_blank" class="menu-item" id="repository" >Github repo</a></h2><h3>Namespaces</h3><ul><li><a href="Auth.html">Auth</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Auth.html#.exports.GenerateAccessResetPasswordToken">exports.GenerateAccessResetPasswordToken</a></li><li data-type='method' style='display: none;'><a href="Auth.html#.exports.GenerateAccessResetPasswordToken">exports.GenerateAccessResetPasswordToken</a></li><li data-type='method' style='display: none;'><a href="Auth.html#.exports.GenerateAccessToken">exports.GenerateAccessToken</a></li><li data-type='method' style='display: none;'><a href="Auth.html#.exports.GenerateAccessToken">exports.GenerateAccessToken</a></li><li data-type='method' style='display: none;'><a href="Auth.html#.exports.ResendVerificationCode">exports.ResendVerificationCode</a></li><li data-type='method' style='display: none;'><a href="Auth.html#.exports.ResetPassword">exports.ResetPassword</a></li><li data-type='method' style='display: none;'><a href="Auth.html#.exports.ResetPassword">exports.ResetPassword</a></li><li data-type='method' style='display: none;'><a href="Auth.html#.exports.SendRestPasswordCode">exports.SendRestPasswordCode</a></li><li data-type='method' style='display: none;'><a href="Auth.html#.exports.SendRestPasswordCode">exports.SendRestPasswordCode</a></li><li data-type='method' style='display: none;'><a href="Auth.html#.exports.VerifyAccount">exports.VerifyAccount</a></li><li data-type='method' style='display: none;'><a href="Auth.html#.exports.logIn">exports.logIn</a></li><li data-type='method' style='display: none;'><a href="Auth.html#.exports.logIn">exports.logIn</a></li><li data-type='method' style='display: none;'><a href="Auth.html#.exports.logOut">exports.logOut</a></li><li data-type='method' style='display: none;'><a href="Auth.html#.exports.signUp">exports.signUp</a></li><li data-type='method' style='display: none;'><a href="Auth.html#.exports.signUp">exports.signUp</a></li></ul></li><li></li><li><a href="Doses.html">Doses</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Doses.html#.exports.ChangeDoseStatus">exports.ChangeDoseStatus</a></li><li data-type='method' style='display: none;'><a href="Doses.html#.exports.EditSingleDose">exports.EditSingleDose</a></li><li data-type='method' style='display: none;'><a href="Doses.html#.exports.SuspendDoses">exports.SuspendDoses</a></li><li data-type='method' style='display: none;'><a href="Doses.html#.exports.TakeAsNeededDose">exports.TakeAsNeededDose</a></li><li data-type='method' style='display: none;'><a href="Doses.html#.exports.getAllDoses">exports.getAllDoses</a></li><li data-type='method' style='display: none;'><a href="Doses.html#.exports.getDoses">exports.getDoses</a></li></ul></li><li><a href="HelperFunctions.html">HelperFunctions</a><ul class='methods'><li data-type='method' style='display: none;'><a href="HelperFunctions.html#.GenerateRefreshToken">GenerateRefreshToken</a></li></ul></li><li><a href="Measurement.html">Measurement</a></li><li></li><li><a href="MedicalCircle.html">MedicalCircle</a><ul class='methods'><li data-type='method' style='display: none;'><a href="MedicalCircle.html#.Cancelinvitationifitisstillpending">Cancel invitation if it is still pending</a></li><li data-type='method' style='display: none;'><a href="MedicalCircle.html#.DeleteDependent">DeleteDependent</a></li><li data-type='method' style='display: none;'><a href="MedicalCircle.html#.EditCareGiverPermissions">EditCareGiverPermissions</a></li><li data-type='method' style='display: none;'><a href="MedicalCircle.html#.deleteCareGiverPermissions">deleteCareGiverPermissions</a></li><li data-type='method' style='display: none;'><a href="MedicalCircle.html#.exports.AddCareGiver">exports.AddCareGiver</a></li><li data-type='method' style='display: none;'><a href="MedicalCircle.html#.exports.CareGiver">exports.CareGiver</a></li><li data-type='method' style='display: none;'><a href="MedicalCircle.html#.exports.ChangeInvitationStatus">exports.ChangeInvitationStatus</a></li><li data-type='method' style='display: none;'><a href="MedicalCircle.html#.exports.ChangeInvitationStatusToAcceptDependent">exports.ChangeInvitationStatusToAcceptDependent</a></li><li data-type='method' style='display: none;'><a href="MedicalCircle.html#.exports.CreateDependentA">exports.CreateDependentA</a></li><li data-type='method' style='display: none;'><a href="MedicalCircle.html#.exports.CreateDependentB">exports.CreateDependentB</a></li><li data-type='method' style='display: none;'><a href="MedicalCircle.html#.exports.Dependents">exports.Dependents</a></li><li data-type='method' style='display: none;'><a href="MedicalCircle.html#.exports.getInvitations">exports.getInvitations</a></li></ul></li><li><a href="Medication.html">Medication</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Medication.html#.exports.CreateNewMed">exports.CreateNewMed</a></li><li data-type='method' style='display: none;'><a href="Medication.html#.exports.EditMed">exports.EditMed</a></li><li data-type='method' style='display: none;'><a href="Medication.html#.exports.deleteMedicationCycle">exports.deleteMedicationCycle</a></li><li data-type='method' style='display: none;'><a href="Medication.html#.exports.getMedication">exports.getMedication</a></li></ul></li><li><a href="Report.html">Report</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Report.html#.exports.getReport">exports.getReport</a></li><li data-type='method' style='display: none;'><a href="Report.html#.exports.getReportSingleMed">exports.getReportSingleMed</a></li></ul></li><li><a href="Settings.html">Settings</a></li><li></li><li><a href="Symptom.html">Symptom</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Symptom.html#.exports.BloodGlucoseMeasurement">exports.BloodGlucoseMeasurement</a></li><li data-type='method' style='display: none;'><a href="Symptom.html#.exports.BloodPressureMeasurement">exports.BloodPressureMeasurement</a></li><li data-type='method' style='display: none;'><a href="Symptom.html#.exports.CreateSymptom">exports.CreateSymptom</a></li><li data-type='method' style='display: none;'><a href="Symptom.html#.exports.DeleteBloodGlucoseMeasurement">exports.DeleteBloodGlucoseMeasurement</a></li><li data-type='method' style='display: none;'><a href="Symptom.html#.exports.DeleteBloodPressureMeasurement">exports.DeleteBloodPressureMeasurement</a></li><li data-type='method' style='display: none;'><a href="Symptom.html#.exports.DeleteSymptom">exports.DeleteSymptom</a></li><li data-type='method' style='display: none;'><a href="Symptom.html#.exports.EditSymptom">exports.EditSymptom</a></li><li data-type='method' style='display: none;'><a href="Symptom.html#.exports.getSymptoms">exports.getSymptoms</a></li></ul></li><li><a href="general.html">general</a></li><li><a href="routes.html">routes</a></li></ul><h3>Global</h3><ul><li><a href="global.html#EditNotificationSettings">EditNotificationSettings</a></li><li><a href="global.html#InvitationSentToCareGiverToBeMaster_AR">InvitationSentToCareGiverToBeMaster_AR</a></li><li><a href="global.html#InvitationSentToCareGiver_AR">InvitationSentToCareGiver_AR</a></li><li><a href="global.html#InvitationSentToDependent_EN">InvitationSentToDependent_EN</a></li><li><a href="global.html#getNotificationSettings">getNotificationSettings</a></li></ul>
    
</nav>

<div id="main">
    
    <h1 class="page-title">Controller/Users/general/index.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>
/**
 * @file controller/general/index.js
 * @namespace controllers
 * @namespace general
 * 
 */
const bcrypt = require("bcryptjs");
const User = require("../../../DB/Schema/User");
const MedRecommendation = require("../../../DB/Schema/MedRecommendation");
const NotificationSchema = require("../../../DB/Schema/Notifications");
const Profile = require("../../../DB/Schema/Profile");
const {UploadFileToAzureBlob}=require("../../../utils/HelperFunctions")
const axios = require('axios');
const {
  successResMsg,
  errorResMsg
} = require("../../../utils/ResponseHelpers");



function escapeRegex(text) {
  return text.replace(/[-[\]{}()*+?.,\\^$|#\s]/g, "\\$&amp;");
};

// change user lang
exports.ChangeUserDefaultLang = async (req, res) => {
 
  try {

    const {lang}=req.body
    const {id} =req.id
    // get user with email
    const user = await User.findById(id);
    if (!user) {
      return errorResMsg(res, 404, req.t("user_not_found"));
    }
    // get user profile
    const profile = await Profile.findById(user.profile);
    user.lang=lang;
    profile.lang=lang;
    await profile.save()
    await user.save()

    // return successful response
    return successResMsg(res, 200, {message:req.t("lang_has_changed")});
  } catch (err) {
    // return error response
    console.log(err)
    return errorResMsg(res, 500, err);
  }
};

exports.SearchForMed = async (req, res) => {
 
  try {

    let results=[];
    if (req.query.name) {
     
      // autocomplete search ?

      const regex = new RegExp(escapeRegex(req.query.name), 'i');
      results = await MedRecommendation.find({
        $or:[{PackageName:regex},{GenericName:regex}]
       
        
      }).limit(5);
    } 
    // return successful response
    return successResMsg(res, 200, {data:results});
  } catch (err) {
    // return error response
    console.log(err)
    return errorResMsg(res, 500, err);
  }
};



 /**
 * getNotifications
 * 
 * @function
 * @memberof controllers
 * @memberof Notification
 * @param {Object} req - Express request object
 * @param {Object} req.id - user id extracted from authorization header
 * @param {Object} req.body - request body
 * @param {string} req.query.ProfileID - Profile ID of the user
 * @param {number} req.query.page - number of the page (pagination logic)
 * 
 * @throws {Error} if the user does not have a profile
 * @throws {Error} if the user is not the owner of the profile  
 * 
 * 
 * @returns {Object} - Returns notifications from latest to oldest
 * @description 
 *     Returns notifications from latest to oldest
     * ********************************
     * logic
         Returns notifications from latest to oldest with Pagination
     * 
     * 
       
 * 
 */

  


exports.Notification = async (req, res) => {
 
  try {

    const {id} =req.id
    const {ProfileID}=req.query
    const page=req.query.page||1
    const itemPerPage = 10 ;
    let totalItems;
   


    const profile =await Profile.findById(ProfileID)
    if(!profile){
      return errorResMsg(res, 400, req.t("Profile_not_found"));
    }
    if(profile.Deleted){
      return errorResMsg(res, 400, req.t("Profile_not_found"));
    }
    
    if(profile.Owner.User._id.toString()!==id){
      return errorResMsg(res, 400, req.t("Unauthorized"));
    }

   

    
        totalItems = await NotificationSchema.find({
          ProfileID:ProfileID,
          isDeleted:false
 
          }).countDocuments();
          const totalNumberOfUnseen = await NotificationSchema.find({
            ProfileID:ProfileID,
            isDeleted:false,
            Seen:false
            }).countDocuments();
          const notifications = await NotificationSchema.find({
            ProfileID:ProfileID,
            isDeleted:false
          

          })
            .sort({createdAt: -1})
            .skip((page - 1) * itemPerPage)
            .limit(itemPerPage);
         
           const results= {
                total:totalItems,
                unSeen:totalNumberOfUnseen,
                notifications
              }
    
    // return successful response
       
    return successResMsg(res, 200, {data:results});
  } catch (err) {
    // return error response
    console.log(err)
    return errorResMsg(res, 500, err);
  }
};



exports.ClearNotifications = async (req, res) => {
 
  try {

    const {id} =req.id
    const {ProfileID,StartDate,EndDate,Seen}=req.body
   


    const profile =await Profile.findById(ProfileID)
    if(!profile){
      return errorResMsg(res, 400, req.t("Profile_not_found"));
    }
    if(profile.Deleted){
      return errorResMsg(res, 400, req.t("Profile_not_found"));
    }
    if(profile.Owner.User._id.toString()!==id){
      return errorResMsg(res, 400, req.t("Unauthorized"));
    }
    if(StartDate&amp;&amp;EndDate){
      await NotificationSchema.updateMany({
        ProfileID: ProfileID,
        createdAt: { $gte: new Date(+StartDate), $lte: new Date(+EndDate) },
        Seen:  Seen || {$exists:true} // if Seen is not provided, this condition will be ignored
      }, {
        $set: { isDeleted: true }
      });
    }else{

      await NotificationSchema.updateMany({
        ProfileID: ProfileID,
        Seen: Seen || {$exists:true}// if Seen is not provided, this condition will be ignored
      }, {
        $set: { isDeleted: true }
      });


    }
   
    //soft delete notifications
    //await NotificationSchema.updateMany({ProfileID:ProfileID},{$set:{isDeleted:true}})
       
    return successResMsg(res, 200, {message:req.t("Notification_Cleared")});
  } catch (err) {
    // return error response
    console.log(err)
    return errorResMsg(res, 500, err);
  }
};

exports.ClearSingleNotification = async (req, res) => {
 
  try {

    const {id} =req.id
    const {ProfileID,NotificationID}=req.body
   


    const profile =await Profile.findById(ProfileID)
    if(!profile){
      return errorResMsg(res, 400, req.t("Profile_not_found"));
    }
    if(profile.Deleted){
      return errorResMsg(res, 400, req.t("Profile_not_found"));
    }
    if(profile.Owner.User._id.toString()!==id){
      return errorResMsg(res, 400, req.t("Unauthorized"));
    }
    // update notification seen status
    const notification =await NotificationSchema.findById(NotificationID)
    if(!notification||notification.isDeleted){
      return errorResMsg(res, 400, req.t("Notification_not_found"));
    }
    if(notification.ProfileID.toString()!=ProfileID.toString()){
      return errorResMsg(res, 400, req.t("Unauthorized"));
    }
    notification.isDeleted=true;
    await notification.save()
       
    return successResMsg(res, 200, {message:req.t("Notification_Cleared")});
  } catch (err) {
    // return error response
    console.log(err)
    return errorResMsg(res, 500, err);
  }
};

exports.ClearMultiNotification = async (req, res) => {
 
  try {

    const {id} =req.id
    const {ProfileID,NotificationIDs}=req.body
   


    const profile =await Profile.findById(ProfileID)
    if(!profile){
      return errorResMsg(res, 400, req.t("Profile_not_found"));
    }
    if(profile.Deleted){
      return errorResMsg(res, 400, req.t("Profile_not_found"));
    }
    if(profile.Owner.User._id.toString()!==id){
      return errorResMsg(res, 400, req.t("Unauthorized"));
    }
    // update notification 
    const notifications =await NotificationSchema.updateMany({
      _id:{$in:NotificationIDs},
    },
    {
      $set:{isDeleted:true}
    })
   
    return successResMsg(res, 200, {message:req.t("Notification_Cleared")});
  } catch (err) {
    // return error response
    console.log(err)
    return errorResMsg(res, 500, err);
  }
};


/**
 * make notification as seen 
 * 
 * @function
 * @memberof controllers
 * @memberof Notification
 * @param {Object} req - Express request object
 * @param {Object} req.id - user id extracted from authorization header
 * @param {Object} req.body - request body
 * @param {string} req.query.ProfileID - Profile ID of the user
 * @param {number} req.body.NotificationID - number of the page (pagination logic)
 * 
 * @throws {Error} if the user does not have a profile
 * @throws {Error} if the user is not the owner of the profile  
 * 
 * 
 * @returns {Object} - Returns success message
 * @description 
 *     get the notification and make Seen value to true
       
 * 
 */



exports.MakeNotificationSeen = async (req, res) => {
 
  try {

    const {id} =req.id
    const {ProfileID,NotificationID}=req.body
   


    const profile =await Profile.findById(ProfileID)
    if(!profile){
      return errorResMsg(res, 400, req.t("Profile_not_found"));
    }
    if(profile.Deleted){
      return errorResMsg(res, 400, req.t("Profile_not_found"));
    }
    if(profile.Owner.User._id.toString()!==id){
      return errorResMsg(res, 400, req.t("Unauthorized"));
    }
    // update notification seen status
    const notification =await NotificationSchema.findById(NotificationID)
    if(!notification){
      return errorResMsg(res, 400, req.t("Notification_not_found"));
    }
    if(notification.ProfileID.toString()!=ProfileID.toString()){
      return errorResMsg(res, 400, req.t("Unauthorized"));
    }
    notification.Seen=true;
    await notification.save()

   

    
       
    return successResMsg(res, 200, {message:req.t("Notification_status_changed")});
  } catch (err) {
    // return error response
    console.log(err)
    return errorResMsg(res, 500, err);
  }
};


exports.MakeMultiNotificationSeen = async (req, res) => {
 
  try {

    const {id} =req.id
    const {ProfileID,NotificationIDs}=req.body
   


    const profile =await Profile.findById(ProfileID)
    if(!profile){
      return errorResMsg(res, 400, req.t("Profile_not_found"));
    }
    if(profile.Deleted){
      return errorResMsg(res, 400, req.t("Profile_not_found"));
    }
    if(profile.Owner.User._id.toString()!==id){
      return errorResMsg(res, 400, req.t("Unauthorized"));
    }
    // update notification seen status
  await NotificationSchema.updateMany({
      _id:{$in:NotificationIDs},
  },{
    $set:{Seen:true}
  })
  
       
    return successResMsg(res, 200, {message:req.t("Notifications_status_changed")});
  } catch (err) {
    // return error response
    console.log(err)
    return errorResMsg(res, 500, err);
  }
};

// make api to return Static data to the caller 
exports.GetStaticData = async (req, res) => {
   
  try {

   
    const {ResourceID}=req.query
    const BaseResourceURL=process.env.Storage_Resource_Base_URL
    let url=`${BaseResourceURL}/${ResourceID}`
    //get the resource from azure blob storage
    console.log("url :",url)

   
    const { data, headers } = await axios({
      url:url ,
      method: 'GET',
      responseType: 'stream',
    });

    // Set the response headers based on the content type of the resource
    res.set('Content-Type', headers['content-type']);
    res.set('Content-Length', headers['content-length']);

    // return the data as response
    data.pipe(res);


    

    
       
   
  } catch (err) {
    // return error response
    console.log("error is ",err)
    return errorResMsg(res, 500, err);
  }
}


</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 4.0.0</a> on Wed Apr 05 2023 14:22:31 GMT+0200 (Eastern European Standard Time) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>

<script src="scripts/search.js" defer></script>


<script src="scripts/collapse.js" defer></script>


</body>
</html>
