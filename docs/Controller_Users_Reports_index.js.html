<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>Controller/Users/Reports/index.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    <input type="text" id="nav-search" placeholder="Search" />
    
    
    <h2><a href="index.html">Home</a></h2><h2><a href="https://github.com/your-github-username/pet-adoption-center-sdk" target="_blank" class="menu-item" id="repository" >Github repo</a></h2><h3>Namespaces</h3><ul><li><a href="Admin.html">Admin</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Admin.html#.Statics">Statics</a></li><li data-type='method' style='display: none;'><a href="Admin.html#.exports.AddMedRecommendation">exports.AddMedRecommendation</a></li><li data-type='method' style='display: none;'><a href="Admin.html#.exports.AddMedRecommendationUS">exports.AddMedRecommendationUS</a></li><li data-type='method' style='display: none;'><a href="Admin.html#.exports.GenerateApiKeysAndSecrets">exports.GenerateApiKeysAndSecrets</a></li><li data-type='method' style='display: none;'><a href="Admin.html#.exports.GetFeedBacks">exports.GetFeedBacks</a></li><li data-type='method' style='display: none;'><a href="Admin.html#.exports.SendNotificationToAllUsers">exports.SendNotificationToAllUsers</a></li></ul></li><li><a href="Auth.html">Auth</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Auth.html#.exports.GenerateAccessResetPasswordToken">exports.GenerateAccessResetPasswordToken</a></li><li data-type='method' style='display: none;'><a href="Auth.html#.exports.GenerateAccessResetPasswordToken">exports.GenerateAccessResetPasswordToken</a></li><li data-type='method' style='display: none;'><a href="Auth.html#.exports.GenerateAccessToken">exports.GenerateAccessToken</a></li><li data-type='method' style='display: none;'><a href="Auth.html#.exports.GenerateAccessToken">exports.GenerateAccessToken</a></li><li data-type='method' style='display: none;'><a href="Auth.html#.exports.ResendVerificationCode">exports.ResendVerificationCode</a></li><li data-type='method' style='display: none;'><a href="Auth.html#.exports.ResetPassword">exports.ResetPassword</a></li><li data-type='method' style='display: none;'><a href="Auth.html#.exports.ResetPassword">exports.ResetPassword</a></li><li data-type='method' style='display: none;'><a href="Auth.html#.exports.SendRestPasswordCode">exports.SendRestPasswordCode</a></li><li data-type='method' style='display: none;'><a href="Auth.html#.exports.SendRestPasswordCode">exports.SendRestPasswordCode</a></li><li data-type='method' style='display: none;'><a href="Auth.html#.exports.VerifyAccount">exports.VerifyAccount</a></li><li data-type='method' style='display: none;'><a href="Auth.html#.exports.logIn">exports.logIn</a></li><li data-type='method' style='display: none;'><a href="Auth.html#.exports.logIn">exports.logIn</a></li><li data-type='method' style='display: none;'><a href="Auth.html#.exports.logOut">exports.logOut</a></li><li data-type='method' style='display: none;'><a href="Auth.html#.exports.signUp">exports.signUp</a></li><li data-type='method' style='display: none;'><a href="Auth.html#.exports.signUp">exports.signUp</a></li></ul></li><li></li><li><a href="Doses.html">Doses</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Doses.html#.exports.ChangeDoseStatus">exports.ChangeDoseStatus</a></li><li data-type='method' style='display: none;'><a href="Doses.html#.exports.EditSingleDose">exports.EditSingleDose</a></li><li data-type='method' style='display: none;'><a href="Doses.html#.exports.SuspendDoses">exports.SuspendDoses</a></li><li data-type='method' style='display: none;'><a href="Doses.html#.exports.TakeAsNeededDose">exports.TakeAsNeededDose</a></li><li data-type='method' style='display: none;'><a href="Doses.html#.exports.getAllDoses">exports.getAllDoses</a></li><li data-type='method' style='display: none;'><a href="Doses.html#.exports.getDoses">exports.getDoses</a></li></ul></li><li><a href="HelperFunctions.html">HelperFunctions</a><ul class='methods'><li data-type='method' style='display: none;'><a href="HelperFunctions.html#.GenerateRefreshToken">GenerateRefreshToken</a></li></ul></li><li><a href="Measurement.html">Measurement</a></li><li></li><li><a href="MedicalCircle.html">MedicalCircle</a><ul class='methods'><li data-type='method' style='display: none;'><a href="MedicalCircle.html#.Cancelinvitationifitisstillpending">Cancel invitation if it is still pending</a></li><li data-type='method' style='display: none;'><a href="MedicalCircle.html#.DeleteDependent">DeleteDependent</a></li><li data-type='method' style='display: none;'><a href="MedicalCircle.html#.EditCareGiverPermissions">EditCareGiverPermissions</a></li><li data-type='method' style='display: none;'><a href="MedicalCircle.html#.deleteCareGiverPermissions">deleteCareGiverPermissions</a></li><li data-type='method' style='display: none;'><a href="MedicalCircle.html#.exports.AddCareGiver">exports.AddCareGiver</a></li><li data-type='method' style='display: none;'><a href="MedicalCircle.html#.exports.CareGiver">exports.CareGiver</a></li><li data-type='method' style='display: none;'><a href="MedicalCircle.html#.exports.ChangeInvitationStatus">exports.ChangeInvitationStatus</a></li><li data-type='method' style='display: none;'><a href="MedicalCircle.html#.exports.ChangeInvitationStatusToAcceptDependent">exports.ChangeInvitationStatusToAcceptDependent</a></li><li data-type='method' style='display: none;'><a href="MedicalCircle.html#.exports.CreateDependentA">exports.CreateDependentA</a></li><li data-type='method' style='display: none;'><a href="MedicalCircle.html#.exports.CreateDependentB">exports.CreateDependentB</a></li><li data-type='method' style='display: none;'><a href="MedicalCircle.html#.exports.Dependents">exports.Dependents</a></li><li data-type='method' style='display: none;'><a href="MedicalCircle.html#.exports.getInvitations">exports.getInvitations</a></li></ul></li><li><a href="Medication.html">Medication</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Medication.html#.exports.CreateNewMed">exports.CreateNewMed</a></li><li data-type='method' style='display: none;'><a href="Medication.html#.exports.EditMed">exports.EditMed</a></li><li data-type='method' style='display: none;'><a href="Medication.html#.exports.deleteMedicationCycle">exports.deleteMedicationCycle</a></li><li data-type='method' style='display: none;'><a href="Medication.html#.exports.getMedication">exports.getMedication</a></li></ul></li><li><a href="Report.html">Report</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Report.html#.exports.getReport">exports.getReport</a></li><li data-type='method' style='display: none;'><a href="Report.html#.exports.getReportSingleMed">exports.getReportSingleMed</a></li></ul></li><li><a href="Settings.html">Settings</a></li><li></li><li><a href="Symptom.html">Symptom</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Symptom.html#.exports.BloodGlucoseMeasurement">exports.BloodGlucoseMeasurement</a></li><li data-type='method' style='display: none;'><a href="Symptom.html#.exports.BloodPressureMeasurement">exports.BloodPressureMeasurement</a></li><li data-type='method' style='display: none;'><a href="Symptom.html#.exports.CreateSymptom">exports.CreateSymptom</a></li><li data-type='method' style='display: none;'><a href="Symptom.html#.exports.DeleteBloodGlucoseMeasurement">exports.DeleteBloodGlucoseMeasurement</a></li><li data-type='method' style='display: none;'><a href="Symptom.html#.exports.DeleteBloodPressureMeasurement">exports.DeleteBloodPressureMeasurement</a></li><li data-type='method' style='display: none;'><a href="Symptom.html#.exports.DeleteSymptom">exports.DeleteSymptom</a></li><li data-type='method' style='display: none;'><a href="Symptom.html#.exports.EditSymptom">exports.EditSymptom</a></li><li data-type='method' style='display: none;'><a href="Symptom.html#.exports.getSymptoms">exports.getSymptoms</a></li></ul></li><li><a href="general.html">general</a></li><li><a href="routes.html">routes</a></li></ul><h3>Global</h3><ul><li><a href="global.html#DeleteRegistration">DeleteRegistration</a></li><li><a href="global.html#EditNotificationSettings">EditNotificationSettings</a></li><li><a href="global.html#InvitationSentToCareGiverToBeMaster_AR">InvitationSentToCareGiverToBeMaster_AR</a></li><li><a href="global.html#InvitationSentToCareGiver_AR">InvitationSentToCareGiver_AR</a></li><li><a href="global.html#InvitationSentToDependent_EN">InvitationSentToDependent_EN</a></li><li><a href="global.html#RegisterAndroidDevice">RegisterAndroidDevice</a></li><li><a href="global.html#RegisterIOSDevice">RegisterIOSDevice</a></li><li><a href="global.html#client">client</a></li><li><a href="global.html#getNotificationSettings">getNotificationSettings</a></li><li><a href="global.html#multer">multer</a></li><li><a href="global.html#sendNotification">sendNotification</a></li><li><a href="global.html#storage">storage</a></li><li><a href="global.html#upload">upload</a></li></ul>
    
</nav>

<div id="main">
    
    <h1 class="page-title">Controller/Users/Reports/index.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @file controller/general/index.js
 * @namespace controllers
 * @namespace Report
 * 
 */



const UserMedication = require("../../../DB/Schema/UserMedication");
const Occurrence = require("../../../DB/Schema/Occurrences");
const Viewer =require("../../../DB/Schema/Viewers")
const mongoose = require("mongoose");
const BloodGlucose =require("../../../DB/Schema/BloodGlucoseManualMeasurement")
const BloodPressure =require("../../../DB/Schema/BloodPressureManualMeasurement")
const {CheckProfilePermissions} =require("../../../utils/HelperFunctions")
const {
  successResMsg,
  errorResMsg
} = require("../../../utils/ResponseHelpers");

const Profile = require("../../../DB/Schema/Profile")



/**
 * get report for all meds
 * 
 * @function
 * @memberof controllers
 * @memberof Report
 * @param {Object} req - Express request object
 * @param {Object} req.id - user id extracted from authorization header
 * @param {Object} req.body - request body
 * @param {string} req.body.StartDate - start date in ms
 * @param {string} req.body.EndDate - EndDate date in ms
 * @param {string} req.body.ProfileID - ProfileID
 
 * @param {Object} res - Express response object
 * 
 * @throws {Error} if the user does not have a profile
 * @throws {Error} if the user is not the owner of the profile or has a permission
 * 
 * 
 * @returns {Object} - return generated report {
 *      
                "med": {
                    "_id": "",
                    "name": "",
                    "strength": ,
                    "unit": ""
                },
                "confirmed": ,
                "rejected": ,
                "ignored":,
                "other": ,
                "total": 
            }
        
 * @description 
 * - get the doses which the user has permission to view
 * - group it with the med
 * -each med should have
 *          {
 *          "confirmed": ,
                "rejected": ,
                 "ignored": ,
                "other": ,
                "total": 
            }
 * -return the data 
       
 * 
 */



exports.getReport=async (req, res) => {

    /** 
     *return all user meds
     * 
     */
    try {
  
      const {id} =req.id
      const {ProfileID,StartDate,EndDate}=req.query
  
  
               /*
      
      check permission 
      
      */
  
      const profile =await Profile.findById(ProfileID).populate("Owner.User")
      if(!profile){
        return errorResMsg(res, 400, req.t("Profile_not_found"));
      }
  
      // get the viewer permissions
      const viewerProfile =await Profile.findOne({
      "Owner.User":id
      })
      
      if(!viewerProfile){
         return errorResMsg(res, 400, req.t("Profile_not_found"));
      }
      if(viewerProfile.Deleted){
        return errorResMsg(res, 400, req.t("Profile_not_found"));
      }
  
      const viewer =await Viewer.findOne({
       ViewerProfile:viewerProfile._id,
       DependentProfile:ProfileID,
       IsDeleted:false

      })
  
      if(!viewer&amp;&amp;profile.Owner.User._id.toString()!==id){
        return errorResMsg(res, 400, req.t("Unauthorized"));
      }
      // check if the user is the owner and has write permission or can add meds
        //case the owner dont has write permission
        // if(profile.Owner.toString()===id&amp;&amp;!profile.Owner.Permissions.read){
        //   return errorResMsg(res, 401, req.t("Unauthorized"));
        // }
        let hasGeneralReadPermissions;
        let hasSpacificReadPermissions;
        if(profile.Owner.User._id.toString()===id){
          hasGeneralReadPermissions=true
        }else{
           hasGeneralReadPermissions=viewer.CanReadDoses;
           hasSpacificReadPermissions=viewer.CanReadSpacificMeds.map(elem=>{
            if(elem.CanReadDoses){
              return elem.Med
            }
          });
        }
      
    
     
   
  
    // case general permission
    if(hasGeneralReadPermissions){
       // case spacific permission
       const doses =await Occurrence.aggregate([{
         $match:{
           ProfileID: mongoose.Types.ObjectId(ProfileID),
           PlannedDateTime:{$gte:new Date(+StartDate),$lte:new Date(+EndDate)},
           isSuspended:false,
           IsDeleted:false,
          
         }
       },
       
          {
            $group: {
             _id: {
               Medication: '$Medication',
             },
             confirmed: {
               $sum: {
                 $cond: {
                   if: { $eq: ['$Status', 2] },
                   then: 1,
                   else: 0
                 }
               }
             },
             rejected: {
               $sum: {
                 $cond: {
                   if: { $eq: ['$Status', 4] },
                   then: 1,
                   else: 0
                 }
               }
             },
             ignored: {
              $sum: {
                $cond: {
                  if: { $eq: ['$Status', 3] },
                  then: 1,
                  else: 0
                }
              }
            },
             other: {
               $sum: {
                 $cond: {
                   if: { $in: ['$Status', [0,1]] },
                   then: 1,
                   else: 0
                 }
               }
             },
             total: { $sum: 1 },
           
       }
         }
   
       ])
   
       const responseData=[];
   
       for (const elem of doses) {
         const med =await UserMedication.findById(elem._id.Medication).select("name img unit strength quantity type")
         .populate("Scheduler")
          .populate("user")
         .select("dosage")
         let DosePerDay=med.Scheduler.dosage.length||0
         
         responseData.push({
           med:{
              _id:elem._id.Medication,
              name:med.name,
              strength:med.strength,  
              unit:med.unit,
              img:med.img,
              quantity:med.quantity,
              StartDate:med.Scheduler.StartDate,
              EndDate:med.Scheduler.EndDate,
              GenerateAutoOccurrence:med.Scheduler.GenerateAutoOccurrence,
              type:med.type

           },
           confirmed:elem.confirmed,
           rejected:elem.rejected,
           other:elem.other,
           total:elem.total,
            ignored:elem.ignored,
            userFirstName:med.user.firstName,
            userLastName:med.user.lastName,
            DosePerDay
         })
       }
       const result = responseData.reduce((acc, item) => {
        acc.confirmed += item.confirmed;
        acc.rejected += item.rejected;
        acc.other += item.other;
        acc.total += item.total;
        return acc;
      }, { confirmed: 0, rejected: 0, other: 0 ,total:0});
      
     const Adherence=result.confirmed/result.total*100||0
      let TotalNumberOFMeds=responseData.length
      console.log(TotalNumberOFMeds)
      console.log(result)
      const editedData={
          MedsData:responseData,
          TotalNumberOFMeds,
          Statics:result,
          Adherence:Adherence.toFixed(2),
          exportProfileData:{
            firstName:profile.Owner.User.firstName,
            lastName:profile.Owner.User.lastName,
            img:profile.Owner.User.img,
            email:profile.Owner.User.email,
          }
  
        
  
        
      

      }
  
   
      // return successful response
      return successResMsg(res, 200, {message:req.t("Success"),data:editedData});
  
    }else if(hasSpacificReadPermissions.length>0){
      // case spacific permission
      ids = hasSpacificReadPermissions.map(function(el) { return mongoose.Types.ObjectId(el) })
  
      const doses =await Occurrence.aggregate([{
        $match:{
          ProfileID: mongoose.Types.ObjectId(ProfileID),
          PlannedDateTime:{$gte:new Date(+StartDate),$lte:new Date(+EndDate)},
          Medication:{$in:ids},
          isSuspended:false,
          IsDeleted:false,
        }
      },
      
      
         {
           $group: {
            _id: {
              Medication: '$Medication',
            },
            confirmed: {
              $sum: {
                $cond: {
                  if: { $eq: ['$Status', 2] },
                  then: 1,
                  else: 0
                }
              }
            },
            rejected: {
              $sum: {
                $cond: {
                  if: { $eq: ['$Status', 4] },
                  then: 1,
                  else: 0
                }
              }
            },
            ignored: {
              $sum: {
                $cond: {
                  if: { $eq: ['$Status', 3] },
                  then: 1,
                  else: 0
                }
              }
            },
            other: {
              $sum: {
                $cond: {
                  if: { $in: ['$Status', [0,1]] },
                  then: 1,
                  else: 0
                }
              }
            },
            total: { $sum: 1 },
          
      }
        }
  
      ])
  
      const responseData=[];
  
      for (const elem of doses) {
        const med =await UserMedication.findById(elem._id.Medication).select("name img unit strength quantity type")
        .populate("Scheduler")
        .populate("user")
        .select("dosage")
        let DosePerDay=med.Scheduler.dosage.length||0
        
       

       
        responseData.push({
          med:{
            _id:elem._id.Medication,
            name:med.name,
            strength:med.strength,  
            unit:med.unit,
            img:med.img,
            quantity:med.quantity,
            StartDate:med.Scheduler.StartDate,
            EndDate:med.Scheduler.EndDate,
            GenerateAutoOccurrence:med.Scheduler.GenerateAutoOccurrence,
            type:med.type


         },
          confirmed:elem.confirmed,
          rejected:elem.rejected,
          other:elem.other,
          total:elem.total,
          ignored:elem.ignored,
          userFirstName:med.user.firstName,
          userLastName:med.user.lastName,
          DosePerDay,
        })
      }

      const result = responseData.reduce((acc, item) => {
        acc.confirmed += item.confirmed;
        acc.rejected += item.rejected;
        acc.other += item.other;
        acc.total += item.total;
        return acc;
      }, { confirmed: 0, rejected: 0, other: 0 ,total:0});
      
     
      let TotalNumberOFMeds=responseData.length
      const Adherence=result.confirmed/result.total*100||0

      console.log(result)
      const editedData={
        MedsData:responseData,
        TotalNumberOFMeds,
        Statics:result,
        Adherence:Adherence.toFixed(2),
        exportProfileData:{
          firstName:profile.Owner.User.firstName,
          lastName:profile.Owner.User.lastName,
          img:profile.Owner.User.img,
          email:profile.Owner.User.email,
        }

      

      }
  
   
      // return successful response
      return successResMsg(res, 200, {message:req.t("Success"),data:editedData});
    }else{
      return errorResMsg(res, 401, req.t("Unauthorized"));
    }
  
      
     
     
      
    } catch (err) {
      // return error response
      console.log(err)
      return errorResMsg(res, 500, err);
    }
  };
  

  /**
 * get report for a single med
 * 
 * @function
 * @memberof controllers
 * @memberof Report
 * @param {Object} req - Express request object
 * @param {Object} req.id - user id extracted from authorization header
 * @param {Object} req.body - request body
 * @param {string} req.body.StartDate - start date in ms
 * @param {string} req.body.EndDate - EndDate date in ms
 * @param {string} req.body.ProfileID - ProfileID
 * @param {string} req.body.MedID - MedID
 
 * @param {Object} res - Express response object
 * 
 * @throws {Error} if the user does not have a profile
 * @throws {Error} if the user is not the owner of the profile or has a permission
 * 
 * 
 * @returns {Object} - return the doses for that med
        
 * @description 
 * check if the user has permission to view this med does
 * return med doses
 * 
       
 * 
 */



  exports.getReportSingleMed=async (req, res) => {
  
    
    try {
  
      const {id} =req.id
      const {ProfileID,StartDate,EndDate,MedID}=req.query
  
      
      /*
      
      check permission 
      
      */
  
      const profile =await Profile.findById(ProfileID).populate("Owner.User")
      if(!profile){
        return errorResMsg(res, 400, req.t("Profile_not_found"));
      }
      if(profile.Deleted){
        return errorResMsg(res, 400, req.t("Profile_not_found"));
      }
    
      // get the viewer permissions
      const viewerProfile =await Profile.findOne({
      "Owner.User":id
      })
      
      if(!viewerProfile){
         return errorResMsg(res, 400, req.t("Profile_not_found"));
      }
      if(viewerProfile.Deleted){
        return errorResMsg(res, 400, req.t("Profile_not_found"));
      }
      const viewer =await Viewer.findOne({
       ViewerProfile:viewerProfile._id,
       DependentProfile:ProfileID,
       IsDeleted:false
      })
  
      if(!viewer&amp;&amp;profile.Owner.User._id.toString()!==id){
        return errorResMsg(res, 400, req.t("Unauthorized"));
      }
      // check if the user is the owner and has write permission or can add meds
        //case the owner dont has write permission
        // if(profile.Owner.toString()===id&amp;&amp;!profile.Owner.Permissions.read){
        //   return errorResMsg(res, 401, req.t("Unauthorized"));
        // }
        let hasGeneralReadPermissions;
        let hasSpacificReadPermissions;
        if(profile.Owner.User._id.toString()===id){
          hasGeneralReadPermissions=true
        }else{
           hasGeneralReadPermissions=viewer.CanReadDoses;
           hasSpacificReadPermissions=viewer.CanReadSpacificMeds.map(elem=>{
            if(elem.CanReadDoses){
              return elem.Med.toString()
            }
          });
        }
      
    
   
  
    // case general permission
    if(hasGeneralReadPermissions){
       // case spasific permission
       const doses =await Occurrence.find({
    
           ProfileID: mongoose.Types.ObjectId(ProfileID),
           PlannedDateTime:{$gte:new Date(+StartDate),$lte:new Date(+EndDate)},
            Medication:mongoose.Types.ObjectId(MedID),
            IsDeleted:false,
            isSuspended:false
       }).populate(
       {
          path:"Medication",
          select:"name img unit strength type"
       }
       ).select("-MedInfo")
       
      
       const editedData=doses.map(dose=>{
        return {
          ...dose._doc,
          exportProfileData:{
            firstName:profile.Owner.User.firstName,
            lastName:profile.Owner.User.lastName,
            img:profile.Owner.User.img,
            email:profile.Owner.User.email,
          }
        }
      })
    
       // return successful response
       return successResMsg(res, 200, {message:req.t("Success"),data:editedData});
  
    }else if(hasSpacificReadPermissions.length>0){
  
       // if the MedID is not in hasSpacificReadPermissions array return Unauthorized
    if(!hasSpacificReadPermissions.includes(MedID)){
      return errorResMsg(res, 401, req.t("Unauthorized"));
    }
    
  
  
       const doses =await Occurrence.find({
    
        ProfileID: mongoose.Types.ObjectId(ProfileID),
        PlannedDateTime:{$gte:new Date(+StartDate),$lte:new Date(+EndDate)},
         Medication:mongoose.Types.ObjectId(MedID),
         isSuspended:false,
         IsDeleted:false,
        
    }).populate(
      {
         path:"Medication",
         select:"name img unit strength type"
      }
      ).select("-MedInfo")
   
      const editedData=doses.map(dose=>{
        return {
          ...dose._doc,
          exportProfileData:{
            firstName:profile.Owner.User.firstName,
            lastName:profile.Owner.User.lastName,
            img:profile.Owner.User.img,
            email:profile.Owner.User.email,
          }
        }
      })
  
    // return successful response
    return successResMsg(res, 200, {message:req.t("Success"),data:editedData});
      
  
      // return successful response
     
    }else{
      return errorResMsg(res, 401, req.t("Unauthorized"));
    }
  
      
     
     
      
    } catch (err) {
      // return error response
      console.log(err)
      return errorResMsg(res, 500, err);
    }
  };
  
  
  exports.getBloodGlucoseMeasurementReport=async (req, res) => {
  
    
    try {
  
      const {id} =req.id
      const {ProfileID,StartDate,EndDate}=req.query
      console.log(ProfileID)
               /*
      
      check permission 
      
      */
  
      const profile =await Profile.findById(ProfileID).populate("Owner.User")
      if(!profile){
        return errorResMsg(res, 400, req.t("Profile_not_found"));
      }
      if(profile.Deleted){
        return errorResMsg(res, 400, req.t("Profile_not_found"));
      }
    
      // get the viewer permissions
      const viewerProfile =await Profile.findOne({
      "Owner.User":id
      })
      if(!viewerProfile){
         return errorResMsg(res, 400, req.t("Profile_not_found"));
      }
      if(viewerProfile.Deleted){
        return errorResMsg(res, 400, req.t("Profile_not_found"));
      }
    
      const viewer =await Viewer.findOne({
       ViewerProfile:viewerProfile._id,
       DependentProfile:ProfileID,
       IsDeleted:false,
       CanReadBloodGlucoseMeasurement:true
      })
  
      if(!viewer&amp;&amp;profile.Owner.User._id.toString()!==id){
        return errorResMsg(res, 400, req.t("Unauthorized"));
      }
  
      // check if the user is the owner or has a read permissions
        // if(profile.Owner.toString()===id&amp;&amp;!profile.Owner.Permissions.read){
        //   return errorResMsg(res, 401, req.t("Unauthorized"));
        // }
    
      if(profile.Owner.User._id.toString() === id){
        if(!CheckProfilePermissions(profile,'CanReadMeasurement')){
          return errorResMsg(res, 400, req.t("Unauthorized"));
        }
      }

      
     
    if(StartDate&amp;&amp;EndDate){
        
      const BloodGlucoseArray =await BloodGlucose.find({
        ProfileID:ProfileID,
        MeasurementDateTime:{
          $gte:new Date(+StartDate),
          $lte:new Date (+EndDate)
        },
        isDeleted:false,
        Status:2
  
      }).populate({
        path:"ProfileID",
        select:"firstName lastName img",
        populate:{
          path:"Owner.User",
          select:"firstName lastName img"
        }
      })
     
     

      
      // return successfully response
      return successResMsg(res, 200, {message:req.t("Success"),data:BloodGlucoseArray});
  
    
   
  
    }else{
        const BloodGlucoseArray =await BloodGlucose.find({
          ProfileID:ProfileID,
          isDeleted:false,
          isDeleted:false,
          Status:2
    
        }).populate({
          path:"ProfileID",
          select:"firstName lastName img",
          populate:{
            path:"Owner.User",
            select:"firstName lastName img"
          }
        })
       
       
        // return successfully response
        return successResMsg(res, 200, {message:req.t("Success"),data:BloodGlucoseArray});
    
      
     
    }
   
  
 
     
      
    } catch (err) {
      // return error response
      console.log(err)
      return errorResMsg(res, 500, err);
    }
  };
  
  exports.getBloodPressureMeasurementReport=async (req, res) => {
  
    
    try {
  
      const {id} =req.id
      const {ProfileID,StartDate,EndDate}=req.query
      console.log(ProfileID)
               /*
      
      check permission 
      
      */
  
      const profile =await Profile.findById(ProfileID).populate("Owner.User")
      if(!profile){
        return errorResMsg(res, 400, req.t("Profile_not_found"));
      }
      if(profile.Deleted){
        return errorResMsg(res, 400, req.t("Profile_not_found"));
      }
    
      // get the viewer permissions
      const viewerProfile =await Profile.findOne({
      "Owner.User":id
      })
      if(!viewerProfile){
         return errorResMsg(res, 400, req.t("Profile_not_found"));
      }
      if(viewerProfile.Deleted){
        return errorResMsg(res, 400, req.t("Profile_not_found"));
      }
    
      const viewer =await Viewer.findOne({
       ViewerProfile:viewerProfile._id,
       DependentProfile:ProfileID,
       IsDeleted:false,
       CanReadBloodPressureMeasurement:true
      })
  
      if(!viewer&amp;&amp;profile.Owner.User._id.toString()!==id){
        return errorResMsg(res, 400, req.t("Unauthorized"));
      }
  
      // check if the user is the owner or has a read permissions
        // if(profile.Owner.toString()===id&amp;&amp;!profile.Owner.Permissions.read){
        //   return errorResMsg(res, 401, req.t("Unauthorized"));
        // }
    
      if(profile.Owner.User._id.toString() === id){
        if(!CheckProfilePermissions(profile,'CanReadMeasurement')){
          return errorResMsg(res, 400, req.t("Unauthorized"));
        }
      }

      
     
    if(StartDate&amp;&amp;EndDate){
        
      const BloodGlucoseArray =await BloodPressure.find({
        ProfileID:ProfileID,
        MeasurementDateTime:{
          $gte:new Date(+StartDate),
          $lte:new Date (+EndDate)
        },
        isDeleted:false,
        Status:2
  
      }).populate({
        path:"ProfileID",
        select:"firstName lastName img",
        populate:{
          path:"Owner.User",
          select:"firstName lastName img"
        }
      })
     
     

      
      // return successfully response
      return successResMsg(res, 200, {message:req.t("Success"),data:BloodGlucoseArray});
  
    
   
  
    }else{
        const BloodGlucoseArray =await BloodPressure.find({
          ProfileID:ProfileID,
          isDeleted:false,
          Status:2
    
        }).populate({
          path:"ProfileID",
          select:"firstName lastName img",
          populate:{
            path:"Owner.User",
            select:"firstName lastName img"
          }
        })
       
       
        // return successfully response
        return successResMsg(res, 200, {message:req.t("Success"),data:BloodGlucoseArray});
    
      
     
    }
   
  
 
     
      
    } catch (err) {
      // return error response
      console.log(err)
      return errorResMsg(res, 500, err);
    }
  };</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 4.0.0</a> on Tue Apr 11 2023 14:12:36 GMT+0200 (Eastern European Standard Time) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>

<script src="scripts/search.js" defer></script>


<script src="scripts/collapse.js" defer></script>


</body>
</html>
