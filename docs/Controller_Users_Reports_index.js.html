<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>Controller/Users/Reports/index.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    <input type="text" id="nav-search" placeholder="Search" />
    
    
    <h2><a href="index.html">Home</a></h2><h2><a href="https://github.com/your-github-username/pet-adoption-center-sdk" target="_blank" class="menu-item" id="repository" >Github repo</a></h2><h3>Namespaces</h3><ul><li><a href="Auth.html">Auth</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Auth.html#.exports.GenerateAccessResetPasswordToken">exports.GenerateAccessResetPasswordToken</a></li><li data-type='method' style='display: none;'><a href="Auth.html#.exports.GenerateAccessToken">exports.GenerateAccessToken</a></li><li data-type='method' style='display: none;'><a href="Auth.html#.exports.ResendVerificationCode">exports.ResendVerificationCode</a></li><li data-type='method' style='display: none;'><a href="Auth.html#.exports.ResetPassword">exports.ResetPassword</a></li><li data-type='method' style='display: none;'><a href="Auth.html#.exports.SendRestPasswordCode">exports.SendRestPasswordCode</a></li><li data-type='method' style='display: none;'><a href="Auth.html#.exports.VerifyAccount">exports.VerifyAccount</a></li><li data-type='method' style='display: none;'><a href="Auth.html#.exports.logIn">exports.logIn</a></li><li data-type='method' style='display: none;'><a href="Auth.html#.exports.signUp">exports.signUp</a></li></ul></li><li><a href="Doses.html">Doses</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Doses.html#.exports.ChangeDoseStatus">exports.ChangeDoseStatus</a></li><li data-type='method' style='display: none;'><a href="Doses.html#.exports.EditSingleDose">exports.EditSingleDose</a></li><li data-type='method' style='display: none;'><a href="Doses.html#.exports.SuspendDoses">exports.SuspendDoses</a></li><li data-type='method' style='display: none;'><a href="Doses.html#.exports.getAllDoses">exports.getAllDoses</a></li><li data-type='method' style='display: none;'><a href="Doses.html#.exports.getDoses">exports.getDoses</a></li></ul></li><li><a href="MedicalCircle.html">MedicalCircle</a><ul class='methods'><li data-type='method' style='display: none;'><a href="MedicalCircle.html#.exports.AddCareGiver">exports.AddCareGiver</a></li><li data-type='method' style='display: none;'><a href="MedicalCircle.html#.exports.CareGiver">exports.CareGiver</a></li><li data-type='method' style='display: none;'><a href="MedicalCircle.html#.exports.ChangeInvitationStatus">exports.ChangeInvitationStatus</a></li><li data-type='method' style='display: none;'><a href="MedicalCircle.html#.exports.ChangeInvitationStatusToAcceptDependent">exports.ChangeInvitationStatusToAcceptDependent</a></li><li data-type='method' style='display: none;'><a href="MedicalCircle.html#.exports.CreateDependentA">exports.CreateDependentA</a></li><li data-type='method' style='display: none;'><a href="MedicalCircle.html#.exports.CreateDependentB">exports.CreateDependentB</a></li><li data-type='method' style='display: none;'><a href="MedicalCircle.html#.exports.Dependents">exports.Dependents</a></li><li data-type='method' style='display: none;'><a href="MedicalCircle.html#.exports.getInvitations">exports.getInvitations</a></li></ul></li><li><a href="Medication.html">Medication</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Medication.html#.exports.CreateNewMed">exports.CreateNewMed</a></li><li data-type='method' style='display: none;'><a href="Medication.html#.exports.EditMed">exports.EditMed</a></li><li data-type='method' style='display: none;'><a href="Medication.html#.exports.deletMedictionCycle">exports.deletMedictionCycle</a></li><li data-type='method' style='display: none;'><a href="Medication.html#.exports.getMedication">exports.getMedication</a></li></ul></li><li><a href="Report.html">Report</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Report.html#.exports.getReport">exports.getReport</a></li><li data-type='method' style='display: none;'><a href="Report.html#.exports.getReportSingleMed">exports.getReportSingleMed</a></li></ul></li><li><a href="Symptom.html">Symptom</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Symptom.html#.exports.CreateSymptom">exports.CreateSymptom</a></li><li data-type='method' style='display: none;'><a href="Symptom.html#.exports.getSymptoms">exports.getSymptoms</a></li></ul></li><li><a href="routes.html">routes</a></li></ul>
    
</nav>

<div id="main">
    
    <h1 class="page-title">Controller/Users/Reports/index.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @file controller/general/index.js
 * @namespace controllers
 * @namespace Report
 * 
 */



const UserMedcation = require("../../../DB/Schema/UserMedcation");
const Occurance = require("../../../DB/Schema/Occurances");
const Viewer =require("../../../DB/Schema/Viewers")
const mongoose = require("mongoose");
const {
  successResMsg,
  errorResMsg
} = require("../../../utils/ResponseHelpers");

const Profile = require("../../../DB/Schema/Profile")



/**
 * get report for all meds
 * 
 * @function
 * @memberof controllers
 * @memberof Report
 * @param {Object} req - Express request object
 * @param {Object} req.id - user id extracted from authorization header
 * @param {Object} req.body - request body
 * @param {string} req.body.StartDate - start date in ms
 * @param {string} req.body.EndDate - EndDate date in ms
 * @param {string} req.body.ProfileID - ProfileID
 
 * @param {Object} res - Express response object
 * 
 * @throws {Error} if the user does not have a profile
 * @throws {Error} if the user is not the owner of the profile or has a permission
 * 
 * 
 * @returns {Object} - return generated report {
 *      
                "med": {
                    "_id": "",
                    "name": "",
                    "strenth": ,
                    "unit": ""
                },
                "confirmed": ,
                "rejected": ,
                "ignored":,
                "other": ,
                "total": 
            }
        
 * @description 
 * - get the doses which the user has permission to view
 * - group it with the med
 * -each med should have
 *          {
 *          "confirmed": ,
                "rejected": ,
                 "ignored": ,
                "other": ,
                "total": 
            }
 * -return the data 
       
 * 
 */



exports.getReport=async (req, res) => {

    /** 
     *return all user meds
     * 
     */
    try {
  
      const {id} =req.id
      const {ProfileID,StartDate,EndDate}=req.query
  
  
               /*
      
      check permission 
      
      */
  
      const profile =await Profile.findById(ProfileID)
      if(!profile){
        return errorResMsg(res, 400, req.t("Profile_not_found"));
      }
  
      // get the viewer permissions
      const viewerProfile =await Profile.findOne({
      "Owner.User":id
      })
      
      if(!viewerProfile){
         return errorResMsg(res, 400, req.t("Profile_not_found"));
      }
  
      const viewer =await Viewer.findOne({
       ViewerProfile:viewerProfile._id,
       DependentProfile:ProfileID
      })
  
      if(!viewer&amp;&amp;profile.Owner.User.toString()!==id){
        return errorResMsg(res, 400, req.t("Unauthorized"));
      }
      // check if the user is the owner and has write permission or can add meds
        //case the owner dont has write permission
        if(profile.Owner.toString()===id&amp;&amp;!profile.Owner.Permissions.read){
          return errorResMsg(res, 401, req.t("Unauthorized"));
        }
        let hasGeneralReadPermissions;
        let hasSpacificReadPermissions;
        if(profile.Owner.User.toString()===id){
          hasGeneralReadPermissions=true
        }else{
           hasGeneralReadPermissions=viewer.CanReadDoses;
           hasSpacificReadPermissions=viewer.CanReadSpacificMeds.map(elem=>{
            if(elem.CanReadDoses){
              return elem.Med
            }
          });
        }
      
    
     
   
  
    // case general permission
    if(hasGeneralReadPermissions){
       // case spacific permission
       const doses =await Occurance.aggregate([{
         $match:{
           ProfileID: mongoose.Types.ObjectId(ProfileID),
           PlannedDateTime:{$gte:new Date(+StartDate),$lte:new Date(+EndDate)},
           isSuspended:false,
          
         }
       },
       
          {
            $group: {
             _id: {
               Medication: '$Medication',
             },
             confirmed: {
               $sum: {
                 $cond: {
                   if: { $eq: ['$Status', 2] },
                   then: 1,
                   else: 0
                 }
               }
             },
             rejected: {
               $sum: {
                 $cond: {
                   if: { $eq: ['$Status', 4] },
                   then: 1,
                   else: 0
                 }
               }
             },
             ignored: {
              $sum: {
                $cond: {
                  if: { $eq: ['$Status', 3] },
                  then: 1,
                  else: 0
                }
              }
            },
             other: {
               $sum: {
                 $cond: {
                   if: { $in: ['$Status', [0,1]] },
                   then: 1,
                   else: 0
                 }
               }
             },
             total: { $sum: 1 },
           
       }
         }
   
       ])
   
       const responseData=[];
   
       for (const elem of doses) {
         const med =await UserMedcation.findById(elem._id.Medication).select("name img unit strenth")
         responseData.push({
           med:med,
           confirmed:elem.confirmed,
           rejected:elem.rejected,
           other:elem.other,
           total:elem.total,
            ignored:elem.ignored
         })
       }
   
    
       // return succesfull response
       return successResMsg(res, 200, {message:req.t("Success"),data:responseData});
  
    }else if(hasSpacificReadPermissions.length>0){
      // case spacific permission
      ids = hasSpacificReadPermissions.map(function(el) { return mongoose.Types.ObjectId(el) })
  
      const doses =await Occurance.aggregate([{
        $match:{
          ProfileID: mongoose.Types.ObjectId(ProfileID),
          PlannedDateTime:{$gte:new Date(+StartDate),$lte:new Date(+EndDate)},
          Medication:{$in:ids},
          isSuspended:false,
        }
      },
      
      
         {
           $group: {
            _id: {
              Medication: '$Medication',
            },
            confirmed: {
              $sum: {
                $cond: {
                  if: { $eq: ['$Status', 2] },
                  then: 1,
                  else: 0
                }
              }
            },
            rejected: {
              $sum: {
                $cond: {
                  if: { $eq: ['$Status', 4] },
                  then: 1,
                  else: 0
                }
              }
            },
            ignored: {
              $sum: {
                $cond: {
                  if: { $eq: ['$Status', 3] },
                  then: 1,
                  else: 0
                }
              }
            },
            other: {
              $sum: {
                $cond: {
                  if: { $in: ['$Status', [0,1]] },
                  then: 1,
                  else: 0
                }
              }
            },
            total: { $sum: 1 },
          
      }
        }
  
      ])
  
      const responseData=[];
  
      for (const elem of doses) {
        const med =await UserMedcation.findById(elem._id.Medication).select("name img unit strenth")
        responseData.push({
          med:med,
          confirmed:elem.confirmed,
          rejected:elem.rejected,
          other:elem.other,
          total:elem.total,
          ignored:elem.ignored
        })
      }
  
   
      // return succesfull response
      return successResMsg(res, 200, {message:req.t("Success"),data:responseData});
    }else{
      return errorResMsg(res, 401, req.t("Unauthorized"));
    }
  
      
     
     
      
    } catch (err) {
      // return error response
      console.log(err)
      return errorResMsg(res, 500, err);
    }
  };
  

  /**
 * get report for a single med
 * 
 * @function
 * @memberof controllers
 * @memberof Report
 * @param {Object} req - Express request object
 * @param {Object} req.id - user id extracted from authorization header
 * @param {Object} req.body - request body
 * @param {string} req.body.StartDate - start date in ms
 * @param {string} req.body.EndDate - EndDate date in ms
 * @param {string} req.body.ProfileID - ProfileID
 * @param {string} req.body.MedID - MedID
 
 * @param {Object} res - Express response object
 * 
 * @throws {Error} if the user does not have a profile
 * @throws {Error} if the user is not the owner of the profile or has a permission
 * 
 * 
 * @returns {Object} - return the doses for that med
        
 * @description 
 * check if the user has permission to view this med does
 * return med doses
 * 
       
 * 
 */



  exports.getReportSingleMed=async (req, res) => {
  
    
    try {
  
      const {id} =req.id
      const {ProfileID,StartDate,EndDate,MedID}=req.query
  
  
               /*
      
      check permission 
      
      */
  
      const profile =await Profile.findById(ProfileID)
      if(!profile){
        return errorResMsg(res, 400, req.t("Profile_not_found"));
      }
  
      // get the viewer permissions
      const viewerProfile =await Profile.findOne({
      "Owner.User":id
      })
      
      if(!viewerProfile){
         return errorResMsg(res, 400, req.t("Profile_not_found"));
      }
  
      const viewer =await Viewer.findOne({
       ViewerProfile:viewerProfile._id,
       DependentProfile:ProfileID
      })
  
      if(!viewer&amp;&amp;profile.Owner.User.toString()!==id){
        return errorResMsg(res, 400, req.t("Unauthorized"));
      }
      // check if the user is the owner and has write permission or can add meds
        //case the owner dont has write permission
        if(profile.Owner.toString()===id&amp;&amp;!profile.Owner.Permissions.read){
          return errorResMsg(res, 401, req.t("Unauthorized"));
        }
        let hasGeneralReadPermissions;
        let hasSpacificReadPermissions;
        if(profile.Owner.User.toString()===id){
          hasGeneralReadPermissions=true
        }else{
           hasGeneralReadPermissions=viewer.CanReadDoses;
           hasSpacificReadPermissions=viewer.CanReadSpacificMeds.map(elem=>{
            if(elem.CanReadDoses){
              return elem.Med.toString()
            }
          });
        }
      
    
   
  
    // case general permission
    if(hasGeneralReadPermissions){
       // case spacific permission
       const doses =await Occurance.find({
    
           ProfileID: mongoose.Types.ObjectId(ProfileID),
           PlannedDateTime:{$gte:new Date(+StartDate),$lte:new Date(+EndDate)},
            Medication:mongoose.Types.ObjectId(MedID)
       }).populate(
       {
          path:"Medication",
          select:"name img unit strenth type"
       }
       ).select("-MedInfo")
       
      
   
    
       // return succesfull response
       return successResMsg(res, 200, {message:req.t("Success"),data:doses});
  
    }else if(hasSpacificReadPermissions.length>0){
  
       // if the MedID is not in hasSpacificReadPermissions array return unauzorized
    if(!hasSpacificReadPermissions.includes(MedID)){
      return errorResMsg(res, 401, req.t("Unauthorized"));
    }
    
  
  
       const doses =await Occurance.find({
    
        ProfileID: mongoose.Types.ObjectId(ProfileID),
        PlannedDateTime:{$gte:new Date(+StartDate),$lte:new Date(+EndDate)},
         Medication:mongoose.Types.ObjectId(MedID),
         isSuspended:false
    }).populate(
    {
       path:"Medication",
       select:"name img unit strenth type"
    }
    ).select("Medication PlannedDateTime PlannedDose Status ProfileID")
    
   
  
  
    // return succesfull response
    return successResMsg(res, 200, {message:req.t("Success"),data:doses});
      
  
      // return succesfull response
      return successResMsg(res, 200, {message:req.t("Success"),data:doses});
    }else{
      return errorResMsg(res, 401, req.t("Unauthorized"));
    }
  
      
     
     
      
    } catch (err) {
      // return error response
      console.log(err)
      return errorResMsg(res, 500, err);
    }
  };
  
  
  </code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 4.0.0</a> on Thu Jan 12 2023 15:33:24 GMT+0200 (Eastern European Standard Time) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>

<script src="scripts/search.js" defer></script>


<script src="scripts/collapse.js" defer></script>


</body>
</html>
